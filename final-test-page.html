<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéØ Final Login Test</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 20px;
      }
      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        padding: 40px;
        max-width: 600px;
        width: 100%;
      }
      .title {
        text-align: center;
        margin-bottom: 30px;
      }
      .title h1 {
        margin: 0;
        color: #1f2937;
        font-size: 28px;
      }
      .title p {
        color: #6b7280;
        margin-top: 10px;
      }
      .test-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 30px 0;
      }
      .test-box {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
      }
      .test-box:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
      }
      .test-box h3 {
        margin: 0 0 15px 0;
        color: #374151;
      }
      .test-box p {
        color: #6b7280;
        margin-bottom: 15px;
        font-size: 14px;
      }
      .btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }
      .btn:hover {
        background: #2563eb;
        transform: translateY(-2px);
      }
      .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 13px;
      }
      .result.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .result.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }
      .user-info {
        background: #f8fafc;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title">
        <h1>üéØ Final Login Verification</h1>
        <p>Testing complete login flow through real application</p>
      </div>

      <div class="test-grid">
        <div class="test-box">
          <h3>üîë Test Login</h3>
          <p>Login with existing user credentials</p>
          <button class="btn" id="loginBtn" onclick="testLogin()">
            üöÄ Login Now
          </button>
          <div id="loginResult" class="result" style="display: none"></div>
        </div>

        <div class="test-box">
          <h3>üîê Verify Token</h3>
          <p>Check stored authentication token</p>
          <button class="btn" id="tokenBtn" onclick="verifyToken()">
            üîç Verify Token
          </button>
          <div id="tokenResult" class="result" style="display: none"></div>
        </div>

        <div class="test-box">
          <h3>üåê Test Auth API</h3>
          <p>Test authenticated request to backend</p>
          <button class="btn" id="authBtn" onclick="testAuthAPI()">
            üîë Test Auth
          </button>
          <div id="authResult" class="result" style="display: none"></div>
        </div>

        <div class="test-box">
          <h3>üíæ Check Database</h3>
          <p>Verify user session in database</p>
          <button class="btn" id="dbBtn" onclick="checkDatabase()">
            üìä Check Database
          </button>
          <div id="dbResult" class="result" style="display: none"></div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = '/api';
      const TEST_USERNAME = 'testuser_650659';
      const TEST_PASSWORD = 'TestPassword123!';

      function showResult(elementId, content, isSuccess) {
        const element = document.getElementById(elementId);
        element.style.display = 'block';
        element.className = `result ${isSuccess ? 'success' : 'error'}`;
        element.innerHTML = content;
      }

      async function testLogin() {
        const btn = document.getElementById('loginBtn');
        btn.disabled = true;
        btn.textContent = 'üîÑ Logging in...';

        try {
          showResult('loginResult', 'üîÑ Attempting login...', true);

          const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: TEST_USERNAME,
              password: TEST_PASSWORD,
            }),
          });

          const data = await response.json();

          if (response.ok && data.data && data.data.token) {
            localStorage.setItem('letschat_token', data.data.token);
            localStorage.setItem(
              'letschat_user',
              JSON.stringify(data.data.user)
            );

            showResult(
              'loginResult',
              `
                        <strong>‚úÖ Login Successful!</strong><br>
                        User: ${data.data.user.username}<br>
                        ID: ${data.data.user.id}<br>
                        Token: ${data.data.token.length} chars
                    `,
              true
            );

            // Enable other tests
            document.getElementById('tokenBtn').disabled = false;
            document.getElementById('authBtn').disabled = false;
            document.getElementById('dbBtn').disabled = false;
          } else {
            showResult(
              'loginResult',
              `
                        <strong>‚ùå Login Failed</strong><br>
                        Status: ${response.status}<br>
                        ${data.error || 'Unknown error'}
                    `,
              false
            );
          }
        } catch (error) {
          showResult(
            'loginResult',
            `
                    <strong>‚ùå Network Error</strong><br>
                    ${error.message}
                `,
            false
          );
        } finally {
          btn.disabled = false;
          btn.textContent = 'üöÄ Login Now';
        }
      }

      function verifyToken() {
        const token = localStorage.getItem('letschat_token');

        if (!token) {
          showResult(
            'tokenResult',
            '‚ùå No token found. Please login first.',
            false
          );
          return;
        }

        try {
          const parts = token.split('.');
          if (parts.length !== 3) {
            throw new Error('Invalid JWT format');
          }

          const payload = JSON.parse(atob(parts[1]));
          const now = Math.floor(Date.now() / 1000);

          if (payload.id && payload.username) {
            showResult(
              'tokenResult',
              `
                        <strong>‚úÖ Token Valid!</strong><br>
                        User ID: ${payload.id}<br>
                        Username: ${payload.username}<br>
                        Issued: ${new Date(payload.iat * 1000).toLocaleString()}<br>
                        Expires: ${new Date(payload.exp * 1000).toLocaleString()}<br>
                        Valid: ${payload.exp > now ? 'YES' : 'NO'}
                    `,
              true
            );
          } else {
            throw new Error('Invalid token payload');
          }
        } catch (error) {
          showResult(
            'tokenResult',
            `
                    <strong>‚ùå Token Invalid</strong><br>
                    ${error.message}
                `,
            false
          );
        }
      }

      async function testAuthAPI() {
        const token = localStorage.getItem('letschat_token');

        if (!token) {
          showResult(
            'authResult',
            '‚ùå No token found. Please login first.',
            false
          );
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/health`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            showResult(
              'authResult',
              `
                        <strong>‚úÖ Authentication Working!</strong><br>
                        Authenticated API request successful<br>
                        Status: ${response.status}
                    `,
              true
            );
          } else {
            showResult(
              'authResult',
              `
                        <strong>‚ùå Authentication Failed</strong><br>
                        API request failed with status: ${response.status}
                    `,
              false
            );
          }
        } catch (error) {
          showResult(
            'authResult',
            `
                    <strong>‚ùå Request Error</strong><br>
                    ${error.message}
                `,
            false
          );
        }
      }

      async function checkDatabase() {
        const userStr = localStorage.getItem('letschat_user');

        if (!userStr) {
          showResult(
            'dbResult',
            '‚ùå No user data found. Please login first.',
            false
          );
          return;
        }

        try {
          const user = JSON.parse(userStr);

          // Simulate database check by making an authenticated request
          const token = localStorage.getItem('letschat_token');
          const response = await fetch(`${API_BASE}/health`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            showResult(
              'dbResult',
              `
                        <strong>‚úÖ Database Session Confirmed!</strong><br>
                        User: ${user.username}<br>
                        Status: ${user.status}<br>
                        Active session: YES<br>
                        Backend integration: WORKING
                    `,
              true
            );
          } else {
            showResult(
              'dbResult',
              `
                        <strong>‚ùå Database Session Issue</strong><br>
                        Authenticated request failed<br>
                        Status: ${response.status}
                    `,
              false
            );
          }
        } catch (error) {
          showResult(
            'dbResult',
            `
                    <strong>‚ùå Database Check Error</strong><br>
                    ${error.message}
                `,
            false
          );
        }
      }

      // Initialize
      document.getElementById('tokenBtn').disabled = true;
      document.getElementById('authBtn').disabled = true;
      document.getElementById('dbBtn').disabled = true;
    </script>
  </body>
</html>
