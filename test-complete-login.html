<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéØ Complete Login Verification</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f8fafc;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 8px 12px;
        border-radius: 6px;
        margin: 10px 0;
        display: inline-block;
      }
      .success {
        background: #10b981;
        color: white;
      }
      .error {
        background: #ef4444;
        color: white;
      }
      .warning {
        background: #f59e0b;
        color: white;
      }
      .info {
        background: #3b82f6;
        color: white;
      }
      .form-group {
        margin: 15px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
      }
      .btn {
        background: #3b82f6;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn:hover {
        background: #2563eb;
      }
      .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
      }
      .result pre {
        background: #f1f5f9;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ Complete Login Verification</h1>
        <p>
          Testing actual application interface with real users and database
          verification
        </p>
      </div>

      <!-- Test 1: Real Login Form -->
      <div class="test-section">
        <h3>üìù Test 1: Real Login Interface</h3>
        <p>Login with existing user: <strong>testuser_new</strong></p>

        <form id="loginForm">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" value="testuser_new" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              value="TestPassword123!"
              required
            />
          </div>
          <button type="submit" class="btn" id="loginBtn">üöÄ Login</button>
        </form>

        <div id="loginResult" class="result" style="display: none"></div>
      </div>

      <!-- Test 2: Token Verification -->
      <div class="test-section">
        <h3>üîê Test 2: JWT Token Verification</h3>
        <button class="btn" onclick="verifyToken()">
          üîç Verify Stored Token
        </button>
        <div id="tokenResult" class="result" style="display: none"></div>
      </div>

      <!-- Test 3: Database Session Check -->
      <div class="test-section">
        <h3>üíæ Test 3: Database Session Verification</h3>
        <button class="btn" onclick="checkDatabase()">
          üìä Check Database Session
        </button>
        <div id="dbResult" class="result" style="display: none"></div>
      </div>

      <!-- Test 4: Authenticated API Test -->
      <div class="test-section">
        <h3>üåê Test 4: Authenticated API Access</h3>
        <button class="btn" onclick="testAuthenticatedAPI()">
          üîë Test Authenticated Request
        </button>
        <div id="apiResult" class="result" style="display: none"></div>
      </div>

      <!-- Test 5: User State Persistence -->
      <div class="test-section">
        <h3>üí´ Test 5: User State Persistence</h3>
        <button class="btn" onclick="checkUserState()">
          üë§ Check User State
        </button>
        <div id="stateResult" class="result" style="display: none"></div>
      </div>
    </div>

    <script>
      const API_BASE = '/api';

      // Test 1: Real Login Form
      document
        .getElementById('loginForm')
        .addEventListener('submit', async e => {
          e.preventDefault();
          const resultDiv = document.getElementById('loginResult');
          const btn = document.getElementById('loginBtn');

          try {
            btn.disabled = true;
            btn.textContent = 'üîÑ Logging in...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML =
              '<div class="status info">üîÑ Attempting login...</div>';

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const response = await fetch(`${API_BASE}/auth/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ username, password }),
            });

            const data = await response.json();

            if (response.ok && data.data?.token && data.data?.user) {
              // Store exactly like the app would
              localStorage.setItem('letschat_token', data.data.token);
              localStorage.setItem(
                'letschat_user',
                JSON.stringify(data.data.user)
              );

              resultDiv.innerHTML = `
                        <div class="status success">‚úÖ Login Successful!</div>
                        <h4>User Details:</h4>
                        <pre>${JSON.stringify(data.data.user, null, 2)}</pre>
                        <h4>Token Info:</h4>
                        <p>Length: ${data.data.token.length}</p>
                        <p>Preview: ${data.data.token.substring(0, 50)}...</p>
                    `;
            } else {
              resultDiv.innerHTML = `
                        <div class="status error">‚ùå Login Failed</div>
                        <h4>Error Response:</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            }
          } catch (error) {
            resultDiv.innerHTML = `
                    <div class="status error">‚ùå Network Error</div>
                    <p>${error.message}</p>
                `;
          } finally {
            btn.disabled = false;
            btn.textContent = 'üöÄ Login';
          }
        });

      // Test 2: Token Verification
      async function verifyToken() {
        const resultDiv = document.getElementById('tokenResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML =
          '<div class="status info">üîÑ Verifying token...</div>';

        try {
          const token = localStorage.getItem('letschat_token');

          if (!token) {
            throw new Error('No token found in localStorage');
          }

          // Parse JWT
          const parts = token.split('.');
          if (parts.length !== 3) {
            throw new Error('Invalid JWT format');
          }

          const payload = JSON.parse(atob(parts[1]));
          const now = Math.floor(Date.now() / 1000);

          resultDiv.innerHTML = `
                    <div class="status success">‚úÖ Token Valid</div>
                    <h4>JWT Payload:</h4>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                    <p><strong>Expired:</strong> ${payload.exp < now ? 'YES' : 'NO'}</p>
                    <p><strong>Expires In:</strong> ${Math.max(0, payload.exp - now)} seconds</p>
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="status error">‚ùå Token Verification Failed</div>
                    <p>${error.message}</p>
                `;
        }
      }

      // Test 3: Database Session Check
      async function checkDatabase() {
        const resultDiv = document.getElementById('dbResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML =
          '<div class="status info">üîÑ Checking database...</div>';

        try {
          const token = localStorage.getItem('letschat_token');
          const userStr = localStorage.getItem('letschat_user');

          if (!token || !userStr) {
            throw new Error('No authentication data found');
          }

          const user = JSON.parse(userStr);

          // Test authenticated endpoint to verify session
          const response = await fetch(`${API_BASE}/health`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            resultDiv.innerHTML = `
                        <div class="status success">‚úÖ Database Session Active</div>
                        <h4>User Session Verified:</h4>
                        <p><strong>User ID:</strong> ${user.id}</p>
                        <p><strong>Username:</strong> ${user.username}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Auth Request:</strong> Success (${response.status})</p>
                    `;
          } else {
            throw new Error(`Auth request failed: ${response.status}`);
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="status error">‚ùå Database Session Check Failed</div>
                    <p>${error.message}</p>
                `;
        }
      }

      // Test 4: Authenticated API Test
      async function testAuthenticatedAPI() {
        const resultDiv = document.getElementById('apiResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML =
          '<div class="status info">üîÑ Testing authenticated API...</div>';

        try {
          const token = localStorage.getItem('letschat_token');

          if (!token) {
            throw new Error('No authentication token');
          }

          // Test multiple endpoints
          const tests = [
            { name: 'Health Check', url: '/api/health' },
            { name: 'Auth Status', url: '/api/auth/status' },
          ];

          const results = [];
          for (const test of tests) {
            try {
              const response = await fetch(test.url, {
                headers: { Authorization: `Bearer ${token}` },
              });
              results.push({
                name: test.name,
                status: response.status,
                success: response.ok,
              });
            } catch (error) {
              results.push({
                name: test.name,
                status: 'ERROR',
                success: false,
                error: error.message,
              });
            }
          }

          const html = results
            .map(
              r => `
                    <div class="status ${r.success ? 'success' : 'error'}">
                        ${r.name}: ${r.status} ${r.success ? '‚úÖ' : '‚ùå'}
                        ${r.error ? `(${r.error})` : ''}
                    </div>
                `
            )
            .join('');

          resultDiv.innerHTML = `
                    <h4>üåê Authenticated API Results:</h4>
                    ${html}
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="status error">‚ùå API Test Failed</div>
                    <p>${error.message}</p>
                `;
        }
      }

      // Test 5: User State Persistence
      function checkUserState() {
        const resultDiv = document.getElementById('stateResult');
        resultDiv.style.display = 'block';

        const token = localStorage.getItem('letschat_token');
        const userStr = localStorage.getItem('letschat_user');

        try {
          const user = userStr ? JSON.parse(userStr) : null;

          resultDiv.innerHTML = `
                    <h4>üë§ User State Analysis:</h4>
                    <div class="status ${token ? 'success' : 'error'}">
                        Token Present: ${token ? 'YES' : 'NO'}
                    </div>
                    <div class="status ${user ? 'success' : 'error'}">
                        User Data Present: ${user ? 'YES' : 'NO'}
                    </div>
                    ${
                      user
                        ? `
                        <h4>Stored User Data:</h4>
                        <pre>${JSON.stringify(user, null, 2)}</pre>
                    `
                        : ''
                    }
                `;
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="status error">‚ùå State Check Failed</div>
                    <p>${error.message}</p>
                `;
        }
      }

      // Initialize
      checkUserState();
    </script>
  </body>
</html>
