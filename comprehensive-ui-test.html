<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App UI Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      input {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 200px;
      }
      .iframe-container {
        width: 100%;
        height: 600px;
        border: 2px solid #ddd;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Chat Application UI Verification</h1>

    <div class="test-section">
      <h2>üì° Server Status</h2>
      <div id="server-status">Checking...</div>
      <button onclick="checkServerStatus()">Refresh Status</button>
    </div>

    <div class="test-section">
      <h2>üë§ User Registration Test</h2>
      <div>
        <input type="text" id="test-username" placeholder="Username" value="" />
        <input type="email" id="test-email" placeholder="Email" value="" />
        <input
          type="password"
          id="test-password"
          placeholder="Password"
          value=""
        />
        <button onclick="testRegistration()">Test Registration</button>
        <button onclick="generateTestUser()">Generate Test User</button>
      </div>
      <div id="registration-result"></div>
    </div>

    <div class="test-section">
      <h2>üîê User Login Test</h2>
      <div>
        <input
          type="text"
          id="login-username"
          placeholder="Username"
          value=""
        />
        <input
          type="password"
          id="login-password"
          placeholder="Password"
          value=""
        />
        <button onclick="testLogin()">Test Login</button>
        <button onclick="testLogout()">Test Logout</button>
      </div>
      <div id="login-result"></div>
    </div>

    <div class="test-section">
      <h2>üîç User Search Test</h2>
      <div>
        <input
          type="text"
          id="search-query"
          placeholder="Search for users..."
          value=""
        />
        <button onclick="testUserSearch()">Search Users</button>
      </div>
      <div id="search-result"></div>
    </div>

    <div class="test-section">
      <h2>üí¨ Message Test</h2>
      <div>
        <input
          type="text"
          id="message-content"
          placeholder="Message content..."
          value="Hello, this is a test message!"
        />
        <button onclick="testSendMessage()">Send Message</button>
        <button onclick="testGetConversations()">Get Conversations</button>
      </div>
      <div id="message-result"></div>
    </div>

    <div class="test-section">
      <h2>üåê Live Application Preview</h2>
      <iframe
        src="http://localhost:5173"
        class="iframe-container"
        id="app-frame"
      ></iframe>
      <div style="margin-top: 10px">
        <button
          onclick="
            document.getElementById('app-frame').src = 'http://localhost:5173'
          "
        >
          üîÑ Refresh App
        </button>
        <button onclick="openAppInNewTab()">üîó Open in New Tab</button>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:3000/api';
      let authToken = null;
      let currentUser = null;

      // Generate unique test user data
      function generateTestUser() {
        const timestamp = Date.now();
        document.getElementById('test-username').value =
          `testuser_${timestamp}`;
        document.getElementById('test-email').value =
          `test_${timestamp}@example.com`;
        document.getElementById('test-password').value = 'TestPassword123!';
        document.getElementById('login-username').value =
          `testuser_${timestamp}`;
        document.getElementById('login-password').value = 'TestPassword123!';
      }

      function openAppInNewTab() {
        window.open('http://localhost:5173', '_blank');
      }

      async function makeRequest(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              'Content-Type': 'application/json',
              ...(authToken && { Authorization: `Bearer ${authToken}` }),
              ...options.headers,
            },
            ...options,
          });

          let data;
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            data = await response.json();
          } else {
            data = await response.text();
          }

          return {
            success: response.ok,
            data,
            status: response.status,
            headers: Object.fromEntries(response.headers.entries()),
          };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      function showResult(elementId, result, isSuccess = null) {
        const element = document.getElementById(elementId);
        const isSuccessful = isSuccess !== null ? isSuccess : result.success;
        element.className = `result ${isSuccessful ? 'success' : 'error'}`;

        let output = '';
        if (typeof result === 'object') {
          output = JSON.stringify(result, null, 2);
        } else {
          output = result;
        }

        element.textContent = output;
      }

      async function checkServerStatus() {
        const statusDiv = document.getElementById('server-status');
        let statusHTML = '';

        // Check frontend
        try {
          const frontendResponse = await fetch('http://localhost:5173');
          const frontendOk = frontendResponse.ok;
          statusHTML += `<div class="${frontendOk ? 'success' : 'error'}">
                    üñ•Ô∏è Frontend (http://localhost:5173): ${frontendOk ? '‚úÖ Running' : '‚ùå Down'}
                </div>`;
        } catch (error) {
          statusHTML += `<div class="error">üñ•Ô∏è Frontend: ‚ùå Error - ${error.message}</div>`;
        }

        // Check backend
        const backendResult = await makeRequest('http://localhost:3000/health');
        if (backendResult.success) {
          statusHTML += `<div class="success">üîß Backend (http://localhost:3000): ‚úÖ Running - ${backendResult.data.uptime?.toFixed(2)}s uptime</div>`;
        } else {
          statusHTML += `<div class="error">üîß Backend: ‚ùå Error - ${backendResult.error}</div>`;
        }

        // Check API docs
        const docsResult = await makeRequest('http://localhost:3000/api-docs/');
        statusHTML += `<div class="${docsResult.success ? 'success' : 'error'}">
                üìö API Documentation: ${docsResult.success ? '‚úÖ Available' : '‚ùå Unavailable'}
            </div>`;

        statusDiv.innerHTML = statusHTML;
      }

      async function testRegistration() {
        const username = document.getElementById('test-username').value;
        const email = document.getElementById('test-email').value;
        const password = document.getElementById('test-password').value;

        if (!username || !email || !password) {
          showResult(
            'registration-result',
            { error: 'Please fill in all fields' },
            false
          );
          return;
        }

        showResult('registration-result', 'Registering...', true);

        const result = await makeRequest(`${API_BASE}/auth/register`, {
          method: 'POST',
          body: JSON.stringify({ username, email, password }),
        });

        showResult('registration-result', result);

        // If registration successful, auto-fill login fields
        if (result.success && result.data) {
          document.getElementById('login-username').value = username;
          document.getElementById('login-password').value = password;
        }
      }

      async function testLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        if (!username || !password) {
          showResult(
            'login-result',
            { error: 'Please fill in username and password' },
            false
          );
          return;
        }

        showResult('login-result', 'Logging in...', true);

        const result = await makeRequest(`${API_BASE}/auth/login`, {
          method: 'POST',
          body: JSON.stringify({ username, password }),
        });

        if (result.success && result.data) {
          if (result.data.token) {
            authToken = result.data.token;
          }
          currentUser = result.data.user || result.data;
          showResult(
            'login-result',
            {
              success: true,
              message: 'Login successful!',
              user: currentUser,
              tokenReceived: !!authToken,
            },
            true
          );
        } else {
          authToken = null;
          currentUser = null;
          showResult('login-result', result);
        }
      }

      async function testLogout() {
        if (!authToken) {
          showResult('login-result', { error: 'No active session' }, false);
          return;
        }

        const result = await makeRequest(`${API_BASE}/auth/logout`, {
          method: 'POST',
        });

        authToken = null;
        currentUser = null;

        showResult(
          'login-result',
          {
            success: result.success,
            message: result.success ? 'Logout successful' : 'Logout failed',
            details: result,
          },
          result.success
        );
      }

      async function testUserSearch() {
        if (!authToken) {
          showResult('search-result', { error: 'Please login first' }, false);
          return;
        }

        const query = document.getElementById('search-query').value || 'test';

        showResult('search-result', 'Searching users...', true);

        const result = await makeRequest(
          `${API_BASE}/users/search?q=${encodeURIComponent(query)}`
        );

        showResult('search-result', result);
      }

      async function testGetConversations() {
        if (!authToken) {
          showResult('message-result', { error: 'Please login first' }, false);
          return;
        }

        showResult('message-result', 'Getting conversations...', true);

        const result = await makeRequest(`${API_BASE}/conversations`);

        showResult('message-result', result);
      }

      async function testSendMessage() {
        if (!authToken) {
          showResult('message-result', { error: 'Please login first' }, false);
          return;
        }

        const content = document.getElementById('message-content').value;

        if (!content) {
          showResult(
            'message-result',
            { error: 'Please enter a message' },
            false
          );
          return;
        }

        showResult('message-result', 'Sending message...', true);

        // First get conversations
        const conversationsResult = await makeRequest(
          `${API_BASE}/conversations`
        );

        if (
          !conversationsResult.success ||
          !conversationsResult.data ||
          conversationsResult.data.length === 0
        ) {
          showResult(
            'message-result',
            {
              error:
                'No conversations found. Please start a conversation first.',
            },
            false
          );
          return;
        }

        const conversationId = conversationsResult.data[0].id;

        // Send message
        const result = await makeRequest(`${API_BASE}/messages`, {
          method: 'POST',
          body: JSON.stringify({
            conversationId,
            content,
            type: 'text',
          }),
        });

        showResult('message-result', result);
      }

      // Auto-check status on load and generate test user
      window.onload = () => {
        checkServerStatus();
        generateTestUser();
      };
    </script>
  </body>
</html>
