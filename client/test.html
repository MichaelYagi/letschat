<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Chat</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        const [user, setUser] = useState(null);
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [isLogin, setIsLogin] = useState(true);
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        // Check if user is already logged in
        useEffect(() => {
          const token = localStorage.getItem('letschat_token');
          if (token) {
            // Verify token with backend
            fetch('http://localhost:3000/api/auth/profile', {
              headers: { Authorization: `Bearer ${token}` },
            })
              .then(res => {
                if (res.ok) {
                  return res.json();
                }
                throw new Error('Invalid token');
              })
              .then(userData => {
                setUser(userData);
              })
              .catch(() => {
                localStorage.removeItem('letschat_token');
              });
          }
        }, []);

        const handleAuth = async e => {
          e.preventDefault();
          setLoading(true);
          setError('');

          const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
          const body = isLogin
            ? { username, password }
            : { username, password, displayName: username };

          try {
            const res = await fetch(`http://localhost:3000${endpoint}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });

            const data = await res.json();

            if (res.ok) {
              localStorage.setItem('letschat_token', data.token);
              setUser(data.user);
            } else {
              setError(data.error || 'Authentication failed');
            }
          } catch (err) {
            setError('Network error. Please try again.');
          } finally {
            setLoading(false);
          }
        };

        const handleLogout = () => {
          localStorage.removeItem('letschat_token');
          setUser(null);
          setUsername('');
          setPassword('');
        };

        const sendTestMessage = async () => {
          try {
            const token = localStorage.getItem('letschat_token');
            const res = await fetch('http://localhost:3000/api/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                conversationId: 'demo-conversation',
                content: 'Hello from test app!',
                contentType: 'text',
              }),
            });

            if (res.ok) {
              alert('Message sent successfully!');
            } else {
              const data = await res.json();
              alert(
                'Failed to send message: ' + (data.error || 'Unknown error')
              );
            }
          } catch (err) {
            alert('Error sending message: ' + err.message);
          }
        };

        if (user) {
          return React.createElement(
            'div',
            { className: 'min-h-screen bg-gray-50 p-8' },
            React.createElement(
              'div',
              { className: 'max-w-4xl mx-auto' },
              React.createElement(
                'div',
                { className: 'bg-white rounded-lg shadow p-6 mb-6' },
                React.createElement(
                  'h1',
                  { className: 'text-2xl font-bold mb-4' },
                  "Welcome, Let's Chat!"
                ),
                React.createElement(
                  'div',
                  { className: 'mb-4' },
                  React.createElement(
                    'p',
                    { className: 'text-gray-600' },
                    `Logged in as: ${user.username || user.displayName}`
                  ),
                  React.createElement(
                    'p',
                    { className: 'text-sm text-gray-500' },
                    `User ID: ${user.id}`
                  )
                ),
                React.createElement(
                  'div',
                  { className: 'space-x-4' },
                  React.createElement(
                    'button',
                    {
                      onClick: sendTestMessage,
                      className:
                        'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700',
                    },
                    'Send Test Message'
                  ),
                  React.createElement(
                    'button',
                    {
                      onClick: handleLogout,
                      className:
                        'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 ml-4',
                    },
                    'Logout'
                  )
                )
              )
            )
          );
        }

        return React.createElement(
          'div',
          {
            className:
              'min-h-screen bg-gray-50 flex items-center justify-center',
          },
          React.createElement(
            'div',
            { className: 'max-w-md w-full mx-4' },
            React.createElement(
              'div',
              { className: 'text-center mb-8' },
              React.createElement(
                'h1',
                { className: 'text-3xl font-bold text-gray-900 mb-2' },
                isLogin ? 'Welcome Back' : 'Create Account'
              ),
              React.createElement(
                'p',
                { className: 'text-gray-600' },
                isLogin ? 'Sign in to your account' : "Join Let's Chat today"
              )
            ),

            error &&
              React.createElement(
                'div',
                {
                  className:
                    'bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-4',
                },
                error
              ),

            React.createElement(
              'form',
              { onSubmit: handleAuth, className: 'space-y-6' },
              React.createElement(
                'div',
                null,
                React.createElement(
                  'label',
                  { className: 'block text-sm font-medium text-gray-700 mb-1' },
                  'Username'
                ),
                React.createElement('input', {
                  type: 'text',
                  value: username,
                  onChange: e => setUsername(e.target.value),
                  className:
                    'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500',
                  placeholder: 'Enter username',
                  required: true,
                  disabled: loading,
                })
              ),

              React.createElement(
                'div',
                null,
                React.createElement(
                  'label',
                  { className: 'block text-sm font-medium text-gray-700 mb-1' },
                  'Password'
                ),
                React.createElement('input', {
                  type: 'password',
                  value: password,
                  onChange: e => setPassword(e.target.value),
                  className:
                    'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500',
                  placeholder: 'Enter password',
                  required: true,
                  disabled: loading,
                })
              ),

              React.createElement(
                'button',
                {
                  type: 'submit',
                  disabled: loading,
                  className:
                    'w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed',
                },
                loading ? 'Loading...' : isLogin ? 'Sign In' : 'Create Account'
              )
            ),

            React.createElement(
              'div',
              { className: 'mt-6 text-center' },
              React.createElement(
                'p',
                { className: 'text-sm text-gray-600' },
                isLogin
                  ? "Don't have an account? "
                  : 'Already have an account? ',
                React.createElement(
                  'button',
                  {
                    type: 'button',
                    onClick: () => setIsLogin(!isLogin),
                    className: 'text-blue-600 hover:text-blue-500 font-medium',
                  },
                  isLogin ? 'Sign up' : 'Sign in'
                )
              )
            )
          )
        );
      }

      ReactDOM.render(
        React.createElement(App),
        document.getElementById('root')
      );
    </script>
  </body>
</html>
